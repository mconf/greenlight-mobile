{"ast":null,"code":"import _slicedToArray from \"@babel/runtime/helpers/slicedToArray\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport { createContext, useCallback, useEffect, useMemo, useState } from 'react';\nimport * as SecureStore from 'expo-secure-store';\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nvar logoutTimer;\nexport var AuthContext = createContext({\n  token: '',\n  isLoggedIn: false,\n  user: {},\n  login: function login() {},\n  logout: function logout() {}\n});\nvar calculateRemainingTime = function calculateRemainingTime(expirationTime) {\n  var currentTime = new Date().getTime();\n  var adjExpirationTime = new Date(expirationTime).getTime();\n  return adjExpirationTime - currentTime;\n};\nvar retrieveStoredToken = function () {\n  var _ref = _asyncToGenerator(function* () {\n    var token = null;\n    try {\n      token = yield SecureStore.getItemAsync('token');\n    } catch (e) {\n      console.error('error retrieveStoredToken', e);\n      yield SecureStore.deleteItemAsync('token');\n    }\n    return {\n      token: token\n    };\n  });\n  return function retrieveStoredToken() {\n    return _ref.apply(this, arguments);\n  };\n}();\nvar retrieveStoredUser = function () {\n  var _ref2 = _asyncToGenerator(function* () {\n    var user = null;\n    try {\n      user = yield SecureStore.getItemAsync('user');\n    } catch (e) {\n      console.error('error retrieveStoredUser', e);\n      yield SecureStore.deleteItemAsync('user');\n    }\n    return JSON.parse(user);\n  });\n  return function retrieveStoredUser() {\n    return _ref2.apply(this, arguments);\n  };\n}();\nexport var AuthContextProvider = function AuthContextProvider(props) {\n  var children = props.children;\n  var initialUser;\n  var initialToken;\n  var _useState = useState(initialToken),\n    _useState2 = _slicedToArray(_useState, 2),\n    token = _useState2[0],\n    setToken = _useState2[1];\n  var _useState3 = useState(initialUser),\n    _useState4 = _slicedToArray(_useState3, 2),\n    user = _useState4[0],\n    setUser = _useState4[1];\n  var userIsLoggedIn = !!token;\n  var retrieveToken = function () {\n    var _ref3 = _asyncToGenerator(function* () {\n      var tokenData = yield retrieveStoredToken();\n      if (tokenData != null && tokenData.token) {\n        setToken(tokenData.token);\n        var storedUser = yield retrieveStoredUser();\n        setUser(storedUser);\n      }\n    });\n    return function retrieveToken() {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n  useEffect(function () {\n    retrieveToken();\n  }, []);\n  var logoutHandler = useCallback(_asyncToGenerator(function* () {\n    setToken(null);\n    setUser({});\n    yield SecureStore.deleteItemAsync('token');\n    yield SecureStore.deleteItemAsync('user');\n  }), []);\n  var loginHandler = function () {\n    var _ref5 = _asyncToGenerator(function* (newToken, newUser, expirationTime) {\n      setToken(newToken);\n      setUser(newUser);\n      yield SecureStore.setItemAsync('token', newToken);\n      yield SecureStore.setItemAsync('user', JSON.stringify(newUser));\n      var remainingTime = calculateRemainingTime(expirationTime);\n      logoutTimer = setTimeout(logoutHandler, remainingTime);\n    });\n    return function loginHandler(_x, _x2, _x3) {\n      return _ref5.apply(this, arguments);\n    };\n  }();\n  var contextValue = useMemo(function () {\n    return {\n      token: token,\n      user: user,\n      isLoggedIn: userIsLoggedIn,\n      login: loginHandler,\n      logout: logoutHandler\n    };\n  }, [token, user, userIsLoggedIn, loginHandler, logoutHandler]);\n  return _jsx(AuthContext.Provider, {\n    value: contextValue,\n    children: children\n  });\n};\nexport default AuthContext;","map":{"version":3,"names":["createContext","useCallback","useEffect","useMemo","useState","SecureStore","jsx","_jsx","logoutTimer","AuthContext","token","isLoggedIn","user","login","logout","calculateRemainingTime","expirationTime","currentTime","Date","getTime","adjExpirationTime","retrieveStoredToken","_ref","_asyncToGenerator","getItemAsync","e","console","error","deleteItemAsync","apply","arguments","retrieveStoredUser","_ref2","JSON","parse","AuthContextProvider","props","children","initialUser","initialToken","_useState","_useState2","_slicedToArray","setToken","_useState3","_useState4","setUser","userIsLoggedIn","retrieveToken","_ref3","tokenData","storedUser","logoutHandler","loginHandler","_ref5","newToken","newUser","setItemAsync","stringify","remainingTime","setTimeout","_x","_x2","_x3","contextValue","Provider","value"],"sources":["/home/matheus/mconf/greenlight-mobile/src/store/context/auth-context.js"],"sourcesContent":["import {\n  createContext, useCallback, useEffect, useMemo, useState\n} from 'react';\nimport * as SecureStore from 'expo-secure-store';\n\nlet logoutTimer;\n\nexport const AuthContext = createContext({\n  token: '',\n  isLoggedIn: false,\n  user: {},\n  login: () => { },\n  logout: () => { },\n});\n\nconst calculateRemainingTime = (expirationTime) => {\n  const currentTime = new Date().getTime();\n  const adjExpirationTime = new Date(expirationTime).getTime();\n\n  return adjExpirationTime - currentTime;\n};\n\nconst retrieveStoredToken = async () => {\n  let token = null;\n  try {\n    token = await SecureStore.getItemAsync('token');\n  } catch (e) {\n    // this only throws if they reinstall the app\n    console.error('error retrieveStoredToken', e);\n    await SecureStore.deleteItemAsync('token');\n  }\n  return { token };\n};\n\nconst retrieveStoredUser = async () => {\n  let user = null;\n  try {\n    user = await SecureStore.getItemAsync('user');\n  } catch (e) {\n    // this only throws if they reinstall the app\n    console.error('error retrieveStoredUser', e);\n    await SecureStore.deleteItemAsync('user');\n  }\n  return JSON.parse(user);\n};\n\nexport const AuthContextProvider = (props) => {\n  const { children } = props;\n\n  let initialUser;\n  let initialToken;\n\n  const [token, setToken] = useState(initialToken);\n  const [user, setUser] = useState(initialUser);\n\n  const userIsLoggedIn = !!token;\n\n  const retrieveToken = async () => {\n    const tokenData = await retrieveStoredToken();\n    if (tokenData?.token) {\n      setToken(tokenData.token);\n      const storedUser = await retrieveStoredUser();\n      setUser(storedUser);\n    }\n  };\n\n  useEffect(() => {\n    retrieveToken();\n  }, []);\n\n  const logoutHandler = useCallback(async () => {\n    setToken(null);\n    setUser({});\n    await SecureStore.deleteItemAsync('token');\n    await SecureStore.deleteItemAsync('user');\n  }, []);\n\n  const loginHandler = async (newToken, newUser, expirationTime) => {\n    setToken(newToken);\n    setUser(newUser);\n    // TODO set user/token/expirationTime in memory\n    await SecureStore.setItemAsync('token', newToken);\n    await SecureStore.setItemAsync('user', JSON.stringify(newUser));\n\n    const remainingTime = calculateRemainingTime(expirationTime);\n\n    logoutTimer = setTimeout(logoutHandler, remainingTime);\n  };\n\n  const contextValue = useMemo(() => {\n    return {\n      token,\n      user,\n      isLoggedIn: userIsLoggedIn,\n      login: loginHandler,\n      logout: logoutHandler,\n    };\n  }, [token, user, userIsLoggedIn, loginHandler, logoutHandler]);\n\n  return (\n    <AuthContext.Provider value={contextValue}>{children}</AuthContext.Provider>\n  );\n};\n\nexport default AuthContext;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}